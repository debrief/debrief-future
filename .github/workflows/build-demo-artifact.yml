# Build Demo Artifact Workflow
# Creates and publishes the Debrief demo artifact to GitHub Releases
#
# The artifact contains:
# - Pre-built Python virtual environment with Debrief packages
# - VS Code extension (.vsix)
# - Desktop integration files (.desktop, MIME types)
# - Sample data files
#
# Triggered on:
# - Push to main branch (creates 'latest' artifact)
# - Release published (creates versioned artifact)

name: Build Demo Artifact

on:
  push:
    branches: [main]
    paths:
      - 'services/**'
      - 'apps/**'
      - 'demo/**'
      - '.github/workflows/build-demo-artifact.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for the artifact (e.g., v0.1.0)'
        required: false
        default: 'dev'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  build:
    name: Build Demo Artifact
    runs-on: ubuntu-22.04  # Match container base (linuxserver/webtop:ubuntu-xfce)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create artifact directory structure
        run: |
          mkdir -p artifact/{venv,extensions,dot-local/share/applications,dot-local/share/mime/packages,bin,samples}
          echo "Artifact directory structure created:"
          find artifact -type d

      # T016: Create venv and install packages with path rewriting
      - name: Create virtual environment
        run: |
          # Create venv with --copies to ensure portability
          python -m venv --copies artifact/venv

          # Upgrade pip
          artifact/venv/bin/pip install --upgrade pip wheel setuptools

      - name: Install Python packages
        run: |
          # Install debrief packages if they exist
          if [ -d "services" ]; then
            for package in services/*/; do
              if [ -f "${package}pyproject.toml" ] || [ -f "${package}setup.py" ]; then
                echo "Installing: $package"
                artifact/venv/bin/pip install "$package" || echo "Warning: Failed to install $package"
              fi
            done
          fi

          # List installed packages
          echo "Installed packages:"
          artifact/venv/bin/pip list

      - name: Make venv relocatable
        run: |
          # Rewrite shebang paths from build path to target path
          BUILD_PATH="$PWD/artifact"
          TARGET_PATH="/opt/debrief"

          # Update shebangs in bin scripts
          for script in artifact/venv/bin/*; do
            if [ -f "$script" ] && head -1 "$script" | grep -q "^#!"; then
              sed -i "s|$BUILD_PATH|$TARGET_PATH|g" "$script"
            fi
          done

          # Verify rewrite
          echo "Verifying path rewrite (first line of python script):"
          head -1 artifact/venv/bin/python3 || true
          head -1 artifact/venv/bin/pip || true

      # T017: Build VS Code extension
      - name: Build VS Code extension
        run: |
          if [ -d "apps/vscode" ]; then
            cd apps/vscode
            npm ci
            npm run package || npm run build || echo "No package/build script found"

            # Find and copy the .vsix file
            VSIX=$(find . -name "*.vsix" -type f | head -1)
            if [ -n "$VSIX" ]; then
              cp "$VSIX" ../../artifact/extensions/debrief.vsix
              echo "VS Code extension packaged: $VSIX"
            else
              echo "Warning: No .vsix file generated"
            fi
            cd ../..
          else
            echo "Note: apps/vscode directory not found, skipping extension build"
          fi

      - name: Copy desktop integration files
        run: |
          # Copy desktop files from demo/desktop
          if [ -d "demo/desktop" ]; then
            cp -r demo/desktop/* artifact/dot-local/
            echo "Desktop integration files copied:"
            find artifact/dot-local -type f
          fi

      - name: Copy entry scripts
        run: |
          # Copy bin scripts from demo/bin
          if [ -d "demo/bin" ]; then
            cp demo/bin/* artifact/bin/
            chmod +x artifact/bin/*
            echo "Entry scripts copied:"
            ls -la artifact/bin/
          fi

      - name: Copy sample files
        run: |
          # Copy sample data files from demo/samples
          if [ -d "demo/samples" ]; then
            cp -r demo/samples/* artifact/samples/
            echo "Sample files copied:"
            ls -la artifact/samples/
          fi

      - name: Create VERSION file
        run: |
          echo "${{ steps.version.outputs.version }}" > artifact/VERSION
          echo "Version file created: $(cat artifact/VERSION)"

      # T019: Verify venv portability
      - name: Verify venv portability
        run: |
          echo "=== Venv Portability Verification ==="

          # Check shebangs don't contain build path
          echo "Checking for build path references..."
          if grep -r "$PWD" artifact/venv/bin/ 2>/dev/null; then
            echo "ERROR: Build path found in venv scripts"
            exit 1
          else
            echo "OK: No build path references found"
          fi

          # Verify Python can be invoked
          echo "Verifying Python interpreter..."
          artifact/venv/bin/python --version

          # Check key packages are importable
          echo "Verifying package imports..."
          artifact/venv/bin/python -c "import sys; print(f'Python: {sys.version}')"

          echo "=== Portability verification passed ==="

      - name: Package artifact
        run: |
          # Create the tarball
          tar czf debrief-demo.tar.gz -C artifact .

          # Show artifact info
          echo "Artifact created:"
          ls -lh debrief-demo.tar.gz

          # List contents
          echo "Artifact contents:"
          tar tzf debrief-demo.tar.gz | head -50

      - name: Upload artifact (workflow)
        uses: actions/upload-artifact@v4
        with:
          name: debrief-demo-${{ steps.version.outputs.version }}
          path: debrief-demo.tar.gz
          retention-days: 30

      # T018: Upload to GitHub Releases
      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: debrief-demo.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # This step would update a 'latest' release with the new artifact
          # For now, we just make it available as a workflow artifact
          echo "Latest artifact built from main branch"
          echo "Download from: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Build summary
        run: |
          echo "## Demo Artifact Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ env.PYTHON_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact Size | $(ls -lh debrief-demo.tar.gz | awk '{print $5}') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Contents" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tar tzf debrief-demo.tar.gz | head -30 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
